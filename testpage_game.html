<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìˆ˜ì–´ ë™í™” ë”°ë¼í•˜ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body class="bg-gray-900 text-gray-100 p-6">
<!-- URLÂ·ë²„íŠ¼ -->
<div class="space-x-2">
  <input id="url" class="w-96 px-2 py-1 rounded text-gray-900"
         placeholder="ìœ íŠœë¸Œ URL" />
  <button id="prepBtn"
          class="bg-amber-600 hover:bg-amber-700 px-4 py-1 rounded">
    ì¤€ë¹„ ì‹œì‘
  </button>
  <button id="playBtn" disabled
          class="bg-indigo-600 hover:bg-indigo-700 px-4 py-1 rounded">
    ì˜ìƒ ì¬ìƒ
  </button>
</div>

<!-- ì•ˆë‚´ë¬¸ + í‰ê°€ ëˆ„ì  -->
<div class="mt-4 flex gap-6">
  <div id="msg" class="text-lg font-bold text-amber-400 grow"></div>
  <ul id="scoreLog" class="space-y-0.5 text-sm text-lime-400"></ul>
</div>

<!-- ì˜ìƒ / ì›¹ìº  -->
<div class="flex gap-4 mt-6">
  <div class="flex-1"><div id="player"
       class="w-full aspect-video bg-black rounded"></div></div>
  <div class="flex-1"><video id="webcam" autoplay playsinline muted
       class="w-full aspect-video bg-black rounded hidden"></video></div>
</div>

<script>
const API = "http://localhost:5000";
let youtubeId="", videoId="", captions=[];
let player=null, idx=0, polling=null, webcam=null, hasWebcam=false;

/* -------------- ì¤€ë¹„ ë²„íŠ¼ -------------- */
document.getElementById("prepBtn").onclick = async () => {
  const url = document.getElementById("url").value.trim();
  if (!url) return alert("URL ì…ë ¥");

  /* 1) ì¤€ë¹„ ì‹œì‘ */
  await fetch(`${API}/prepare_youtube`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({url})
  });
  document.getElementById("msg").textContent = "â³ ëœë“œë§ˆí¬ ì¶”ì¶œ ì¤‘â€¦";

  /* 2) ìë§‰ */
  const sub = await fetch(`${API}/get_subtitle`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({url,lang:"ko"})
  }).then(r=>r.json());
  captions = sub.captions;
  youtubeId = videoId = sub.youtube_id;

  /* 3) ì¤€ë¹„ ì™„ë£Œ í´ë§ */
  polling = setInterval(async ()=>{
    const js = await fetch(`${API}/check_ready?youtube_id=${youtubeId}`)
                      .then(r=>r.json());
    if (js.ready) {
      clearInterval(polling);
      document.getElementById("msg").textContent="âœ… ì¤€ë¹„ ì™„ë£Œ! 'ì˜ìƒ ì¬ìƒ' í´ë¦­";
      document.getElementById("playBtn").disabled=false;
    }
  }, 3000);
};

/* -------------- ì˜ìƒ ì¬ìƒ ë²„íŠ¼ -------------- */
document.getElementById("playBtn").onclick = async () => {
  document.getElementById("playBtn").disabled=true;
  player = new YT.Player("player",{
    videoId,
    playerVars:{controls:0,autoplay:1,mute:1,playsinline:1,
      modestbranding:1,rel:0,fs:0,disablekb:1},
    events:{onReady:()=>{idx=0;next();}}
  });
  try{
    webcam = await navigator.mediaDevices.getUserMedia({video:true});
    hasWebcam=true;
    const v=document.getElementById("webcam");
    v.srcObject=webcam; v.classList.remove("hidden");
  }catch{hasWebcam=false;}
};

/* -------------- í”Œë ˆì´ ë£¨í”„ -------------- */
function next(){
  if(idx>=captions.length){
    document.getElementById("msg").textContent="ğŸ‰ ë!";
    return;
  }
  const c=captions[idx], dur=c.dur||3;
  player.seekTo(c.start,true); player.playVideo();
  document.getElementById("msg").textContent=c.text.trim()?c.text:"â€¦";
  setTimeout(()=>{player.pauseVideo(); afterPause(c);},dur*1000);
}

async function afterPause(c){
  if(!c.text.trim()||!hasWebcam){idx++;setTimeout(next,500);return;}

  /* ë…¹í™” */
  const rec=new MediaRecorder(webcam,{mimeType:"video/webm"});
  const chunks=[]; rec.ondataavailable=e=>{if(e.data.size)chunks.push(e.data)};
  rec.start(); setTimeout(()=>rec.stop(),c.dur*1000);

  rec.onstop=async()=>{
    const f=new FormData();
    f.append("video", new Blob(chunks,{type:"video/webm"}),"cam.webm");
    f.append("youtube_id",youtubeId);
    f.append("caption_start",c.start); f.append("caption_dur",c.dur);

    const res=await fetch(`${API}/evaluate_caption`,{method:"POST",body:f})
                    .then(r=>r.json())
                    .catch(()=>({rating:"error",score:9999}));

    /* ì•ˆë‚´ë¬¸ í…ìŠ¤íŠ¸ */
    document.getElementById("msg").textContent=
      `â­ ${res.rating.toUpperCase()} (${Math.round(res.score)})`;

    /* â˜… ëˆ„ì  ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ â˜… */
    const li=document.createElement("li");
    li.textContent=`#${idx+1}  ${res.rating.toUpperCase()}  (${Math.round(res.score)})`;
    document.getElementById("scoreLog").appendChild(li);

    idx++; setTimeout(next,800);
  };
}
</script>
</body>
</html>
